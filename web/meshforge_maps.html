<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeshForge Maps</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="/css/meshforge-maps.css" />
    <!-- <style> block extracted to css/meshforge-maps.css -->
</head>
<body>

<div class="header">
    <span class="header-title">MeshForge Maps</span>
    <span class="header-subtitle" id="headerSubtitle">Multi-Source Mesh Network Map</span>
    <div class="header-stats" id="headerStats">
        <span class="status-indicator status-loading" id="connStatus">
            <span class="status-dot"></span>
            <span id="connLabel">Loading</span>
        </span>
        <span class="stat-badge">
            <span class="stat-dot" style="background:#66bb6a"></span>
            <span id="statMeshtastic">0</span> Meshtastic
        </span>
        <span class="stat-badge">
            <span class="stat-dot" style="background:#ab47bc"></span>
            <span id="statReticulum">0</span> RNS
        </span>
        <span class="stat-badge">
            <span class="stat-dot" style="background:#ff7043"></span>
            <span id="statAredn">0</span> AREDN
        </span>
        <span class="stat-badge" id="mqttBadge" style="display:none">
            <span class="stat-dot" style="background:#42a5f5"></span>
            MQTT <span id="statMqtt">0</span>
        </span>
        <span class="header-alert-badge" id="headerAlertBadge" onclick="toggleAlertPanel()">
            <span class="alert-sev-critical" style="width:6px;height:6px;border-radius:50;display:inline-block"></span>
            <span id="headerAlertCount">0</span> Alerts
        </span>
    </div>
</div>

<button class="toggle-panel-btn" onclick="togglePanel()">Controls</button>

<div class="control-panel" id="controlPanel">
    <div class="panel-section">
        <div class="panel-section-title">Map Style</div>
        <select class="map-style-select" id="tileSelect" onchange="changeTileLayer()">
            <!-- Populated dynamically -->
        </select>
    </div>

    <div class="panel-section">
        <div class="panel-section-title">Network Layers</div>
        <label class="layer-toggle">
            <input type="checkbox" id="layerMeshtastic" checked onchange="toggleLayer('meshtastic')">
            <span class="layer-color" style="background:#66bb6a"></span>
            <span class="layer-label">Meshtastic</span>
            <span class="layer-count" id="countMeshtastic">0</span>
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="layerReticulum" checked onchange="toggleLayer('reticulum')">
            <span class="layer-color" style="background:#ab47bc"></span>
            <span class="layer-label">Reticulum / RMAP</span>
            <span class="layer-count" id="countReticulum">0</span>
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="layerAredn" checked onchange="toggleLayer('aredn')">
            <span class="layer-color" style="background:#ff7043"></span>
            <span class="layer-label">AREDN</span>
            <span class="layer-count" id="countAredn">0</span>
        </label>
    </div>

    <div class="panel-section">
        <div class="panel-section-title">Overlays</div>
        <label class="layer-toggle">
            <input type="checkbox" id="overlayTerminator" checked onchange="toggleTerminator()">
            <span class="layer-color" style="background:#ffc107"></span>
            <span class="layer-label">Solar Terminator</span>
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="overlayClustering" checked onchange="toggleClustering()">
            <span class="layer-color" style="background:#4fc3f7"></span>
            <span class="layer-label">Marker Clustering</span>
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="overlayTopology" onchange="toggleTopology()">
            <span class="layer-color" style="background:#29b6f6"></span>
            <span class="layer-label">Topology Links</span>
            <span class="layer-count" id="countLinks">0</span>
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="overlayTrajectory" onchange="toggleTrajectoryPanel()">
            <span class="layer-color" style="background:#ffc107"></span>
            <span class="layer-label">Node History</span>
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="overlayHealth" onchange="toggleHealthOverlay()">
            <span class="layer-color" style="background:#e91e63"></span>
            <span class="layer-label">Node Health</span>
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="overlayAlerts" onchange="toggleAlertPanel()">
            <span class="layer-color" style="background:#ef5350"></span>
            <span class="layer-label">Alerts</span>
            <span class="layer-count" id="countAlerts">0</span>
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="overlayWeatherAlerts" onchange="toggleWeatherAlerts()">
            <span class="layer-color" style="background:#f44336"></span>
            <span class="layer-label">Weather Alerts</span>
            <span class="layer-count" id="countWeatherAlerts">0</span>
        </label>
        <label class="layer-toggle">
            <input type="checkbox" id="overlayAnalytics" onchange="toggleAnalyticsPanel()">
            <span class="layer-color" style="background:#4fc3f7"></span>
            <span class="layer-label">Analytics</span>
        </label>
    </div>

    <div class="panel-section" id="weatherSection">
        <div class="panel-section-title">Space Weather</div>
        <div class="weather-grid">
            <div class="weather-item">
                <div class="weather-value" id="wxSFI">--</div>
                <div class="weather-label">SFI</div>
            </div>
            <div class="weather-item">
                <div class="weather-value" id="wxKp">--</div>
                <div class="weather-label">Kp Index</div>
            </div>
            <div class="weather-item">
                <div class="weather-value" id="wxWind">--</div>
                <div class="weather-label">Solar Wind</div>
            </div>
            <div class="weather-item">
                <div class="weather-value" id="wxBand">--</div>
                <div class="weather-label">HF Cond.</div>
            </div>
        </div>
        <div class="band-conditions band-unknown" id="bandBar">
            Band Conditions: Loading...
        </div>
    </div>

    <div class="panel-section" id="hamclockSection" style="display:none">
        <div class="panel-section-title">Propagation</div>
        <div class="station-info" id="stationInfo" style="display:none">
            <div class="station-box">
                <div class="station-label">DE (Home)</div>
                <div class="station-call" id="deCall">--</div>
                <div class="station-grid" id="deGrid">--</div>
            </div>
            <div class="station-box">
                <div class="station-label">DX (Target)</div>
                <div class="station-call" id="dxCall">--</div>
                <div class="station-grid" id="dxGrid">--</div>
            </div>
        </div>
        <div id="voacapBands" style="margin-top:6px"></div>
        <div id="dxspotContainer" style="margin-top:8px;display:none">
            <div style="font-size:10px;color:#78909c;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">DX Spots</div>
            <div class="dxspot-list" id="dxspotList"></div>
        </div>
        <div class="hamclock-source" id="hamclockSource">--</div>
    </div>

    <div class="panel-section">
        <div class="panel-section-title">Data</div>
        <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
            Refresh All Sources
        </button>
        <div class="last-updated" id="lastUpdated">Not yet loaded</div>
    </div>
</div>

<div id="map"></div>

<div class="history-panel" id="historyPanel">
    <div class="history-panel-title">
        <span>Node History</span>
        <button class="history-close-btn" onclick="toggleTrajectoryPanel()">&times;</button>
    </div>
    <div class="history-node-list" id="historyNodeList">
        <div style="color:#546e7a;font-size:11px;text-align:center;padding:12px">Loading tracked nodes...</div>
    </div>
</div>

<div class="alert-panel" id="alertPanel">
    <div class="alert-panel-header">
        <span class="alert-panel-title">
            Alerts <span class="alert-badge-count" id="alertBadgeCount">0</span>
        </span>
        <button class="alert-panel-close" onclick="toggleAlertPanel()">&times;</button>
    </div>
    <div class="alert-panel-body" id="alertPanelBody">
        <div class="alert-empty">No alerts</div>
    </div>
</div>

<div class="analytics-panel" id="analyticsPanel">
    <div class="analytics-panel-header">
        <span class="analytics-panel-title">Network Analytics</span>
        <span>
            <button class="export-btn" onclick="exportAnalytics('json')" title="Export JSON">JSON</button>
            <button class="export-btn" onclick="exportAnalytics('csv')" title="Export CSV">CSV</button>
            <button class="analytics-panel-close" onclick="toggleAnalyticsPanel()">&times;</button>
        </span>
    </div>
    <div class="analytics-tabs">
        <button class="analytics-tab active" data-tab="growth" onclick="switchAnalyticsTab('growth')">Growth</button>
        <button class="analytics-tab" data-tab="activity" onclick="switchAnalyticsTab('activity')">Activity</button>
        <button class="analytics-tab" data-tab="ranking" onclick="switchAnalyticsTab('ranking')">Ranking</button>
        <button class="analytics-tab" data-tab="alerts" onclick="switchAnalyticsTab('alerts')">Alert Trends</button>
    </div>
    <div class="analytics-body" id="analyticsBody">
        <div style="color:#546e7a;font-size:11px;text-align:center;padding:24px">Loading analytics...</div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script src="/js/meshforge-maps.js"></script>

</body>
</html>
